;-----------------------------------------------------
; Программа для самостоятельной работы (Задание 10.5)
; Точное следование алгоритму:
; 1. Вывод приглашения "Как Вас зовут?"
; 2. Ввод с клавиатуры фамилии и имени
; 3. Создание файла name.txt
; 4. Запись в файл сообщения "Меня зовут"
; 5. Дописывание в файл введенной строки
; 6. Закрытие файла
;-----------------------------------------------------

%include 'in_out.asm'     ; Подключаем файл с функциями ввода-вывода

SECTION .data
    ; Сообщения и строки
    prompt  db 'Как Вас зовут? ', 0h   ; Приглашение для ввода
    msg     db 'Меня зовут ', 0h       ; Сообщение для записи
    newline db 0Ah, 0h                 ; Символ новой строки
    filename db 'name.txt', 0h         ; Имя файла
    
SECTION .bss
    name    resb 255      ; Буфер для ввода имени

SECTION .text
    global _start

_start:
    ; --- Шаг 1: Вывод приглашения "Как Вас зовут?" ---
    mov eax, prompt      ; Загружаем адрес приглашения
    call sprint          ; Выводим строку на экран

    ; --- Шаг 2: Ввод с клавиатуры фамилии и имени ---
    mov ecx, name        ; Адрес буфера для ввода
    mov edx, 255         ; Максимальная длина ввода
    call sread           ; Читаем строку с клавиатуры

    ; --- Шаг 3: Создание файла с именем name.txt ---
    mov ecx, 0644o       ; Права доступа: rw-r--r--
    mov ebx, filename    ; Имя файла: "name.txt"
    mov eax, 8           ; Номер системного вызова sys_creat
    int 80h              ; Вызов ядра
    ; В eax теперь дескриптор созданного файла
    
    mov esi, eax         ; Сохраняем дескриптор файла

    ; --- Шаг 4: Запись в файл сообщения "Меня зовут" ---
    mov eax, msg         ; Адрес сообщения
    call slen            ; Вычисляем длину строки
    mov edx, eax         ; Длина строки для записи
    mov ecx, msg         ; Адрес строки "Меня зовут "
    mov ebx, esi         ; Дескриптор файла
    mov eax, 4           ; sys_write
    int 80h

    ; --- Шаг 5: Дописать в файл строку, введенную с клавиатуры ---
    ; Вычисляем длину введенной строки и убираем символ новой строки
    mov eax, name        ; Адрес введенной строки
    call slen            ; Вычисляем длину
    
    ; Уменьшаем длину на 1, чтобы убрать символ новой строки
    dec eax
    
    ; Записываем введенную строку в файл (без символа новой строки)
    mov edx, eax         ; Длина строки для записи
    mov ecx, name        ; Адрес введенной строки
    mov ebx, esi         ; Дескриптор файла
    mov eax, 4           ; sys_write
    int 80h

    ; --- Добавляем символ новой строки в конец файла ---
    mov edx, 1           ; Длина = 1 символ
    mov ecx, newline     ; Адрес символа новой строки
    mov ebx, esi         ; Дескриптор файла
    mov eax, 4           ; sys_write
    int 80h

    ; --- Шаг 6: Закрыть файл ---
    mov ebx, esi         ; Дескриптор файла
    mov eax, 6           ; sys_close
    int 80h

    ; --- Завершение программы ---
    call quit            ; Корректный выход
